trigger:
- main

variables:
  azureSubscription: 'Azure-Service-Connection'
  webAppName: 'mywebappatul98600'
  resourceGroupName: 'bluegreen'
  slotName: 'staging'
  artifactName: 'drop'
  nodeVersion: '24.x'

stages:

# =========================
# BUILD STAGE
# =========================
- stage: Build
  displayName: Build Application
  jobs:
  - job: BuildJob
    pool:
      vmImage: ubuntu-latest
    steps:
    # Use Node.js 24 LTS
    - task: NodeTool@0
      displayName: 'Install Node.js'
      inputs:
        versionSpec: $(nodeVersion)

    # Install dependencies
    - script: |
        npm install
      displayName: 'npm install'

    # Run tests (if available)
    - script: |
        npm test
      displayName: 'Run tests'
      continueOnError: true

    # Copy files for deployment
    - task: CopyFiles@2
      displayName: 'Copy Files to Staging'
      inputs:
        SourceFolder: '$(Build.SourcesDirectory)'
        Contents: |
          **/*
          !node_modules/**
          !.git/**
          !.gitignore
          !azure-pipelines.yml
          !README.md
          !.vscode/**
        TargetFolder: '$(Build.ArtifactStagingDirectory)/app'

    # Archive application
    - task: ArchiveFiles@2
      displayName: 'Archive files'
      inputs:
        rootFolderOrFile: '$(Build.ArtifactStagingDirectory)/app'
        includeRootFolder: false
        archiveType: zip
        archiveFile: '$(Build.ArtifactStagingDirectory)/app.zip'
        replaceExistingArchive: true

    # Publish artifact
    - publish: '$(Build.ArtifactStagingDirectory)'
      artifact: $(artifactName)
      displayName: 'Publish Artifact'

# =========================
# DEPLOY TO GREEN (STAGING)
# =========================
- stage: Deploy_Staging
  displayName: Deploy to Green Slot (Staging)
  dependsOn: Build
  jobs:
  - job: DeployGreen
    pool:
      vmImage: ubuntu-latest
    steps:
    - download: current
      artifact: $(artifactName)

    # Configure staging slot for Oryx build
    - task: AzureAppServiceSettings@1
      displayName: 'Configure Staging Slot App Settings'
      inputs:
        azureSubscription: $(azureSubscription)
        appName: $(webAppName)
        resourceGroupName: $(resourceGroupName)
        slotName: $(slotName)
        appSettings: |
          [
            {
              "name": "SCM_DO_BUILD_DURING_DEPLOYMENT",
              "value": "true",
              "slotSetting": false
            },
            {
              "name": "ENABLE_ORYX_BUILD",
              "value": "true",
              "slotSetting": false
            },
            {
              "name": "NODE_ENV",
              "value": "production",
              "slotSetting": false
            }
          ]

    # Deploy to staging slot (Green environment)
    - task: AzureWebApp@1
      displayName: 'Deploy to Staging Slot'
      inputs:
        azureSubscription: $(azureSubscription)
        appType: 'webAppLinux'
        appName: $(webAppName)
        deployToSlotOrASE: true
        resourceGroupName: $(resourceGroupName)
        slotName: $(slotName)
        package: '$(Pipeline.Workspace)/$(artifactName)/app.zip'
        runtimeStack: 'NODE|24-lts'
    
    # Health check after deployment
    - script: |
        echo "Waiting for staging slot to be ready..."
        sleep 30
        STAGING_URL="https://$(webAppName)-$(slotName).azurewebsites.net/health"
        echo "Checking health at: $STAGING_URL"
        for i in {1..10}; do
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" $STAGING_URL)
          if [ $STATUS -eq 200 ]; then
            echo "✓ Health check passed (Status: $STATUS)"
            exit 0
          fi
          echo "Attempt $i: Status $STATUS, retrying..."
          sleep 10
        done
        echo "✗ Health check failed after 10 attempts"
        exit 1
      displayName: 'Health Check - Staging Slot'

# =========================
# MANUAL APPROVAL (OPTIONAL)
# =========================
- stage: Approval
  displayName: Manual Approval
  dependsOn: Deploy_Staging
  jobs:
  - job: ApprovalJob
    pool: server
    steps:
    - task: ManualValidation@0
      inputs:
        instructions: |
          Please verify the staging environment before swapping to production:
          
          Staging URL: https://$(webAppName)-$(slotName).azurewebsites.net
          Health Check: https://$(webAppName)-$(slotName).azurewebsites.net/health
          API Info: https://$(webAppName)-$(slotName).azurewebsites.net/api/info
          
          If everything looks good, approve to proceed with the swap.
        timeoutInMinutes: 60

# =========================
# SWAP GREEN → BLUE
# =========================
- stage: Swap_To_Production
  displayName: Swap Staging with Production
  dependsOn: Approval
  jobs:
  - job: SwapSlot
    pool:
      vmImage: ubuntu-latest
    steps:
    # Swap staging slot to production
    - task: AzureAppServiceManage@0
      displayName: 'Swap Slots (Green → Blue)'
      inputs:
        azureSubscription: $(azureSubscription)
        Action: 'Swap Slots'
        WebAppName: $(webAppName)
        ResourceGroupName: $(resourceGroupName)
        SourceSlot: $(slotName)
        SwapWithProduction: true

    # Verify production after swap
    - script: |
        echo "Waiting for production slot to be ready..."
        sleep 30
        PROD_URL="https://$(webAppName).azurewebsites.net/health"
        echo "Checking health at: $PROD_URL"
        for i in {1..10}; do
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" $PROD_URL)
          if [ $STATUS -eq 200 ]; then
            echo "✓ Production health check passed (Status: $STATUS)"
            echo "Deployment successful! App is live at: https://$(webAppName).azurewebsites.net"
            exit 0
          fi
          echo "Attempt $i: Status $STATUS, retrying..."
          sleep 10
        done
        echo "✗ Production health check failed after swap"
        exit 1
      displayName: 'Health Check - Production Slot'
